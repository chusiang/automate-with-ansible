# ç¾ä»£ IT äººä¸€å®šè¦çŸ¥é“çš„ Ansible è‡ªå‹•åŒ–çµ„æ…‹æŠ€å·§

## 03. æ€éº¼éƒ¨ç½² Ansible ç’°å¢ƒï¼Ÿ

åœ¨æœ¬æ¬¡çš„ç« ç¯€è£¡ï¼Œå‡ä»å°‡ç°¡å–®åœ°ä»‹ç´¹ Ansible åŸºæœ¬è§€å¿µå’Œæ€éº¼å®‰è£ã€è¨­å®š Ansibleã€‚

![automate_with_ansible_basic-11.jpg](imgs/automate_with_ansible_basic-11.jpg)


### Ansible æ˜¯æ€éº¼é‹ä½œçš„ï¼Ÿ

åœ¨ Ansible çš„ä¸–ç•Œè£¡ï¼Œæˆ‘å€‘æœƒé€é **inventory æª”æ¡ˆ**ä¾†å®šç¾©æœ‰å“ªäº› **Managed node** (è¢«æ§ç«¯)ï¼Œä¸¦è—‰ç”± **SSH** å’Œ **Python** é€²è¡Œæºé€šã€‚

![automate_with_ansible_basic-12.jpg](imgs/automate_with_ansible_basic-12.jpg)

æ›å¥è©±èªªï¼Œç•¶ Control Machine (ä¸»æ§ç«¯) å¯ä»¥ç”¨ SSH é€£ä¸Š Managed nodeï¼Œä¸”è¢«é€£ä¸Šçš„æ©Ÿå™¨è£¡æœ‰é è¼‰ Python æ™‚ï¼ŒAnsible å°±å¯ä»¥é‹ä½œäº†ï¼

- `Control Machine` æŒ‡çš„æ˜¯æˆ‘å€‘ä¸»è¦æœƒåœ¨ä¸Šé¢æ“ä½œ Ansible çš„æ©Ÿå™¨ï¼Œå‡ä»å–œæ­¡ç”¨**ä¸»æ§ç«¯**ä¾†å½¢å®¹å®ƒã€‚å®ƒå¯ä»¥æ˜¯æˆ‘å€‘å¹³æ™‚ç”¨çš„é›»è…¦ã€æ‰‹æ©Ÿ [^1] æˆ–æ©Ÿæˆ¿è£¡çš„æŸä¸€å°æ©Ÿå™¨ï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒæƒ³æˆæ˜¯ä¸€èˆ¬ Lab ç·´ç¿’è£¡çš„ `Workstation`ã€‚

- `Managed node` å‰‡æ˜¯è¢« Ansible æ“ç¸±çš„æ©Ÿå™¨ï¼Œå‡ä»å–œæ­¡ç”¨**è¢«æ§ç«¯**ä¾†å½¢å®¹å®ƒã€‚åœ¨å¾ˆå¤šçš„ Lab ç·´ç¿’è£¡æœƒç”¨ `Server` ä¾†ç¨±å‘¼å®ƒã€‚


### æ€éº¼å®‰è£ Ansibleï¼Ÿ

åœ¨ä¸€èˆ¬çš„æƒ…æ³ä¸‹ï¼Œ**æˆ‘å€‘åªéœ€åœ¨ Control Machine è£¡å®‰è£ Ansible å³å¯**ï¼Œå› ç‚º GNU/Linux å’Œ macOS çš„ Managed node éƒ½æ—©å·²é è¼‰äº† Python 2.5 ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œä¸”é–‹é€šäº† SSH é€£ç·šçš„æ¢ä»¶ã€‚

è‹¥æƒ³æ‹¿ Ansible ä¾†ç®¡ Windows äº†è©±ï¼Œå‰‡éœ€é€²è¡Œè¼ƒå¤šçš„è¨­ç½®ï¼Œé€™éƒ¨ä»½å‡ä»å°‡åœ¨ä¹‹å¾Œçš„ã€Œæ€éº¼ç”¨ Ansible ç®¡ Windowsï¼Ÿã€ä¸€æ–‡æåˆ°ï¼Œç•¶ç„¶å¤§å®¶ä¹Ÿå¯ä»¥å…ˆåƒè€ƒå‡ä»å…ˆå‰çš„[ç°¡å ±][automate-with-ansible-roles-windows]å’Œ[å®˜æ–¹æ–‡ä»¶][windows_support]ã€‚

[automate-with-ansible-roles-windows]: http://note.drx.tw/2016/07/automate-with-ansible-roles-windows.html
[windows_support]: http://docs.ansible.com/ansible/intro_windows.html

![automate_with_ansible_basic-13.jpg](imgs/automate_with_ansible_basic-13.jpg)

#### åœ¨ Control Machine ä¸Šå®‰è£ Ansible

ç¤™æ–¼æ–‡ç« ç¯‡å¹…ï¼Œé€™è£¡åªæœƒæåˆ°å‡ä»è¼ƒå¸¸ç”¨çš„ç’°å¢ƒï¼Œå…¶é¤˜çš„éƒ¨ä»½é‚„è«‹åƒè€ƒ[å®˜æ–¹æ–‡ä»¶][ansible_official_installation]å’Œ Ansible å°ç£ä½¿ç”¨è€…ç¤¾ç¾¤æ‰€ç¶­è­·çš„ [Ansible å®‰è£æ•™å­¸][ansible_tw_installation]ã€‚

[ansible_official_installation]: http://docs.ansible.com/ansible/intro_installation.html
[ansible_tw_installation]: http://ansible.tw/#!docs/installation.md

> ç›®å‰æœ€æ–°é‡‹å‡ºçš„ Ansible ç‰ˆæœ¬ç‚º v2.2.0.0ã€‚

##### Ubuntu (Apt)

1. å®‰è£ `add-apt-repository` å¿…è¦å¥—ä»¶ã€‚

  ```
  $ sudo apt-get install -y python-software-properties software-properties-common
  ```

2. ä½¿ç”¨ Ansible å®˜æ–¹çš„ PPA å¥—ä»¶ä¾†æºã€‚

  ```
  $ sudo add-apt-repository -y ppa:ansible/ansible; sudo apt-get update
  ```

3. å®‰è£ Ansibleã€‚

  ```
  $ sudo apt-get install -y ansible
  ```

##### CentOS (Yum)

1. æ–°å¢ `epel-release` ç¬¬ä¸‰æ–¹å¥—ä»¶ä¾†æºã€‚

  ```
  $ sudo yum install -y epel-release
  ```

2. å®‰è£ Ansibleã€‚

  ```
  $ sudo yum install -y ansible
  ```

##### macOS (Homebrew)

1. è«‹å…ˆå®‰è£ [homebrew](http://brew.sh/index_zh-tw.html)ï¼Œå·²å®‰è£è€…è«‹ç•¥éã€‚

  ```
  $ /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  ```

2. å®‰è£ Ansibleã€‚

  ```
  $ brew install ansible
  ```

##### Python (Pip)

Ansible è¿‘ä¾†çš„é‡‹å‡ºé€Ÿåº¦å¾ˆå¿«ï¼Œè‹¥æƒ³è¿½æ±‚è¼ƒæ–°çš„ç‰ˆæœ¬å¯æ”¹ç”¨ **Pip** çš„æ–¹å¼é€²è¡Œå®‰è£ï¼Œè¼ƒä¸å»ºè­°åˆå­¸è€…ä½¿ç”¨ã€‚

1. éœ€è«‹å…ˆå®‰è£ [pip][pip]ï¼Œå·²å®‰è£è€…è«‹ç•¥éã€‚

  ```
  # Debian, Ubuntu
  $ sudo apt-get install -y python-pip

  # CentOS
  $ sudo yum install -y python-pip

  # macOS
  $ sudo easy_install pip
  ```

  [pip]: https://pypi.python.org/pypi/pip

2. å‡ç´š pipã€‚

  ```
  $ sudo pip install -U pip
  ```

3. å®‰è£ Ansibleã€‚
        
  ```
  $ sudo pip install ansible
  ```

#### åœ¨ Managed Node å®‰è£ OpenSSH server å’Œ Python

æ­£å¸¸åœ¨ Managed Node æˆ‘å€‘éƒ½æœƒå®‰è£ OpenSSH server å’Œé–‹é€šé€£ç·šæ¬Šé™ä»¥ä¾¿æ–¼é ç«¯ç®¡ç†ï¼ŒOpenSSH é€™é‚Šå‡ä»å°±ä¸å¤šåŠ è´…è¿°äº†ã€‚

Python çš„éƒ¨ä»½å‘¢ï¼Ÿé›–èªªç¾ä»£çš„ GNU/Linux å¤§å¤šéƒ½æ—©å·²å…§å»ºäº†ï¼Œå¯ Ansible é è¨­ä½¿ç”¨çš„ Python æ˜¯ 2.x çš„ç‰ˆæœ¬ï¼Œé€™åœ¨ Ubuntu 16.04 é è¼‰ Python 3.4 çš„ç’°å¢ƒä¸Šéœ€åšäº›èª¿æ•´ï¼Œè©³æƒ…è«‹åƒé–± [Python 3 Support | Ansible Documentation][ansible_docs_python3_support] ä¸€æ–‡ã€‚[^2]

[ansible_docs_python3_support]: https://docs.ansible.com/ansible/python_3_support.html

- Ubuntu.

  ```
  $ sudo apt-get install -y openssh-server python2.7
  ```

- CentOS.

  ```
  $ sudo yum install -y openssh-server python
  ```

- macOS: åœ¨ macOS 10.11 è£¡ï¼Œæˆ‘å€‘åªéœ€ä½¿ç”¨å…§å»ºçš„ OpenSSH server å’Œ Python å³å¯ï¼Œè©³æƒ…è«‹åƒè€ƒ Apple å®˜æ–¹çš„ [OS X El Capitan: å…è¨±é ç«¯é›»è…¦å–ç”¨æ‚¨çš„ Mac](https://support.apple.com/kb/PH21839?viewlocale=zh_TW&locale=zh_TW) ä¸€æ–‡é€²è¡Œè¨­ç½®ã€‚


### æ€éº¼è¨­å®š Ansibleï¼Ÿ

æˆ‘å€‘å¯ä»¥è—‰ç”± `ansible.cfg` ä¾†è¨­å®šé è¨­çš„ **inventory æª”æ¡ˆçš„è·¯å¾‘**ã€**é ç«¯ä½¿ç”¨è€…åç¨±**å’Œ **SSH é‡‘é‘°è·¯å¾‘**ç­‰ç›¸é—œè¨­å®šã€‚

![automate_with_ansible_basic-14.jpg](imgs/automate_with_ansible_basic-14.jpg)

1. å®‰è£å¥½ Ansible å¾Œï¼Œæˆ‘å€‘å¯ä»¥åœ¨ `/etc/ansible/` çš„ç›®éŒ„åº•ä¸‹æ‰¾åˆ° Ansible çš„è¨­å®šæª”ã€‚
2. é€šå¸¸æˆ‘å€‘è¼ƒåæ„›æŠŠ `ansible.cfg` å’Œ `hosts` é€™å…©å€‹æª”æ¡ˆèˆ‡å…¶å®ƒçš„ `Playbooks` æ”¾åœ¨åŒå€‹å°ˆæ¡ˆç›®éŒ„åº•ä¸‹ï¼Œç„¶å¾Œé€éç‰ˆæœ¬æ§åˆ¶ç³»çµ± (ä¾‹å¦‚ Git) æŠŠå®ƒå€‘ä¸€èµ·å„²å­˜èµ·ä¾†ï¼Œä»¥å¯¦ç¾ Ansible çš„ [*Infrastructure as Code*][infra_as_code]ï¼

[infra_as_code]: https://en.wikipedia.org/wiki/Infrastructure_as_Code


#### inventory æ˜¯ä»€éº¼ï¼Ÿ

`inventory` å°±å–®å­—æœ¬èº«æœ‰**è©³ç´°ç›®éŒ„**ã€**æ¸…å–®**å’Œ**åˆ—è¡¨**çš„æ„æ€ã€‚åœ¨é€™è£¡æˆ‘å€‘å¯ä»¥æŠŠå®ƒç•¶æˆæ˜¯ä¸€ä»½ä¸»æ©Ÿåˆ—è¡¨ï¼Œæˆ‘å€‘å¯é€éå®ƒå°å®šç¾©æ¯å€‹ Managed Node çš„ä»£è™Ÿã€IP ä½å€ã€é€£ç·šç›¸é—œè³‡è¨Šå’Œç¾¤çµ„ã€‚

![automate_with_ansible_basic-15.jpg](imgs/automate_with_ansible_basic-15.jpg)

1. è‹¥æœ‰å° Control Machine æœ¬æ©Ÿæ“ä½œçš„éœ€æ±‚ï¼Œå»ºè­°æ–¼ `/etc/ansible/hosts` è£œä¸Š local çš„è¨­å®šã€‚

  ```
  # For root user.
  $ /bin/echo -e "[local]\nlocalhost ansible_connection=local" >> /etc/ansible/hosts

  # For sudo user.
  $ sudo su -c '/bin/echo -e "[local]\nlocalhost ansible_connection=local" >> /etc/ansible/hosts'
  ```


#### Hello World

ç•¶å·²ä¸Šçš„è¨­ç½®éƒ½å®Œæˆäº†ï¼Œæ‚¨å¯ä»¥è©¦è‘—åœ¨çµ‚ç«¯æ©Ÿè£¡ç”¨ Ansible å‘¼å«æœ¬æ©Ÿå°å‡º `Hello World`ã€‚

```
$ ansible localhost -m command -a 'echo Hello World.'
localhost | SUCCESS | rc=0 >>
Hello World.
```

æ­¡è¿ä¾†åˆ° Ansible çš„ä¸–ç•Œï¼:D


### è³‡æ–™ä¾†æº

- [ç¾ä»£ IT äººä¸€å®šè¦çŸ¥é“çš„ Ansible è‡ªå‹•åŒ–çµ„æ…‹æŠ€å·§ | å‡ä»çš„ç­†è¨˜](http://note.drx.tw/2016/05/automate-with-ansible-basic.html)


[^1]: ç›¸ä¿¡åœ¨é€™å€‹æ™ºæ…§å‹æ‰‹æ©Ÿè£¡ç››è¡Œçš„æ™‚ä»£ï¼Œè¦åœ¨æ‰‹æ©Ÿè£¡è£å€‹ Python å’Œ OpenSSH ä¸€å®šä¸æ˜¯ä»€éº¼é›£äº‹ (ç¬‘)ã€‚åœ¨å°ç£é‚„æœ‰äººæ•´åˆäº† Ansible èˆ‡èŠå¤©æ©Ÿå™¨äºº (Chatbot)ï¼Œé€™æ¨£å‡ºé–€åœ¨å¤–åªè¦æœ‰æ‰‹æ©Ÿå’Œç¶²è·¯å°±å¯ä»¥é ç«¯å·¥ä½œäº†ï¼(è©³æƒ…è«‹åƒè€ƒ[å¾ DevOps åˆ° ChatOpsï¼šWar Roomã€Bots èˆ‡ Automation][devops-chatopswar-roombots-automation] çš„ç°¡å ±)

[^2]: Ansible å·²åœ¨ 2.2 æ™‚åŠ å…¥äº† Python 3 Support çš„åŠŸèƒ½ï¼Œæ„Ÿè¬å‹äºº [@maxsolar][@maxsolar] çš„ feedbackï¼Œé€™ä¸‹å‡ä»å¯ä»¥å°‘å¯«ä¸€ç¯‡æ–‡ç« äº†ï¼

[devops-chatopswar-roombots-automation]: http://www.slideshare.net/warfan/devops-chatopswar-roombots-automation
[@maxsolar]: https://github.com/maxsolar
